(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
'use strict';

var migrationDates = [new Date(2018, 4, 19), new Date(2018, 4, 5), new Date(2018, 3, 22), new Date(2018, 3, 8), new Date(2018, 2, 22), new Date(2018, 2, 8), new Date(2018, 1, 25)];

var nestUpdates = [new Date(2018, 3, 30), new Date(2011, 0, 1)];

var pokemonImagesUrl = 'https://raw.githubusercontent.com/pogo-excalibur' + '/images/master/pogo';

window.initMap = function () {
  var map = new google.maps.Map(document.getElementById('map'), {
    center: Settings.get('mapCenter'),
    zoom: Settings.get('zoomLevel'),
    gestureHandling: 'greedy',
    fullscreenControl: false,
    streetViewControl: true,
    mapTypeControl: true,
    clickableIcons: false,
    mapTypeControlOptions: {
      style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
      position: google.maps.ControlPosition.RIGHT_TOP,
      mapTypeIds: [google.maps.MapTypeId.ROADMAP, google.maps.MapTypeId.SATELLITE, google.maps.MapTypeId.HYBRID]
    }
  });

  initNests(map);
  initSettings(map);
};

function initNests(map) {
  loadNestData()
  /* If a nest is given as a URL parameter then zoom to it. */
  .then(function (nestData) {
    var centerNestName = urlParameter('nest');
    if (centerNestName) {
      var centerNest = void 0;
      $.each(nestData, function (nestId, nest) {
        if (nest.permalinkName == centerNestName) {
          centerNest = nest;
          return false;
        }
      });

      if (centerNest) {
        zoomToNest(map, centerNest);
      }
    }

    return nestData;
  }).then(function (nestData) {
    return Promise.all([nestData, loadMigrationData(nestData), loadPokemonData()]);
  }).then(function (results) {
    var nestData = results[0];
    var allMigrationData = results[1];
    var pokemonData = results[2];

    $.each(allMigrationData, function (index, migrationData) {
      var date = migrationDates[index];

      $.each(nestData, function (nestId, nest) {
        if (migrationData[nestId]) {
          if (migrationData[nestId].id === undefined) {
            var pokeData = pokemonData[migrationData[nestId]];
            migrationData[nestId] = {
              id: migrationData[nestId],
              name: pokeData.name
            };
          }

          if (!nest.migrations) {
            nest.migrations = [];
          }

          nest.migrations[date] = migrationData[nestId];
        }
      });
    });

    return nestData;
  }).then(function (nestData) {
    $.each(nestData, function (nestId, nest) {
      drawNest(map, nest);
    });
  });
}

function initSettings(map) {
  google.maps.event.addListener(map, 'idle', function () {
    Settings.set('mapCenter', {
      lat: map.getCenter().lat(),
      lng: map.getCenter().lng()
    });
    Settings.set('zoomLevel', map.getZoom());
  });
}

function loadNestData() {
  return Promise.resolve($.getJSON('/data/nests.json')).then(function (nestData) {
    return Promise.resolve($.getJSON('/data/manual_nests.json')).then(function (manualNestData) {
      return Object.assign(nestData, manualNestData);;
    });
  }).then(function (nestData) {
    $.each(nestData, function (nestId, nest) {
      nest.center = coordinateToLatLng(nest.center);

      nest.region = $.map(nest.region, function (coord) {
        return coordinateToLatLng(coord);
      });

      nest.permalinkName = nest.name.replace(/[^\w]/g, '').toLowerCase();
    });

    return nestData;
  });
}

function loadMigrationData(nestData) {
  return Promise.all($.map(migrationDates, function (date) {
    var migrationFile = '/data/nest_migrations/' + dateToString(date) + '.json';
    return Promise.resolve($.getJSON(migrationFile));
  }));
}

function loadPokemonData() {
  return Promise.resolve($.getJSON('/data/pokemon.json'));
}

function zoomToNest(map, nest) {
  map.panTo(nest.center);
  map.setZoom(17);
}

function drawNest(map, nest) {
  nest.polygon = nestRegion(nest);
  nest.polygon.setMap(map);

  nest.marker = nestMarker(nest);
  nest.marker.setMap(map);

  nest.label = nestLabel(nest);

  function labelClick() {
    if (nest.label.isOpen) {
      nest.label.close();
      nest.label.isOpen = false;
    } else {
      nest.label.setPosition(nest.center);
      nest.label.open(map);
      nest.label.isOpen = true;
    }
  }

  nest.label.isOpen = false;

  nest.polygon.addListener('click', function () {
    labelClick();
  });

  nest.marker.addListener('click', function () {
    labelClick();
  });

  map.addListener('click', function () {
    nest.label.close();
    nest.label.isOpen = false;
  });

  nest.label.addListener('closeclick', function () {
    nest.label.isOpen = false;
  });
}

function nestRegion(nest) {
  var nestColor = 'green';
  if (nest.date_added == dateToString(nestUpdates[0])) {
    nestColor = 'blue';
  }

  return new google.maps.Polygon({
    paths: nest.region,
    fillColor: nestColor,
    fillOpacity: 0.5,
    strokeColor: nestColor,
    strokeOpacity: 1,
    strokeWeight: 0
  });
}

function nestMarker(nest) {
  var icon = nestIcon(nest);

  if (icon) {
    return new google.maps.Marker({
      position: nest.center,
      icon: nestIcon(nest)
    });
  } else {
    return new google.maps.Marker();
  }
}

function nestIcon(nest) {
  var nestPokemon = nestMigrationData(nest, migrationDates[0]);

  if (nestPokemon) {
    return {
      url: pokemonImagesUrl + '/' + nestPokemon.id + '.png',
      scaledSize: new google.maps.Size(34, 34),
      anchor: new google.maps.Point(17, 17)
    };
  }
}

function nestLabel(nest) {
  function pokemonNameStr(pokemon) {
    return pokemon ? pokemon.name + ' (#' + pokemon.id + ')' : '?';
  }

  var allNestingPokemon = $.map(migrationDates, function (date, index) {
    var dateStr = index == 0 ? 'Current' : dateToString(date);
    var pokemon = nestMigrationData(nest, date);

    return '\n      <div class="nest-label-pokemon">\n        ' + dateStr + ': ' + pokemonNameStr(pokemon) + '\n      </div>';
  }).join('\n');

  var baseURL = location.protocol + '//' + location.host + location.pathname;
  var permaLink = baseURL + '?nest=' + nest.permalinkName;

  var spawnpointCount = void 0;
  if (nest.spawnpoints) {
    if (nest.spawnpoints > 1) {
      spawnpointCount = nest.spawnpoints + ' spawnpoints';
    } else {
      spawnpointCount = nest.spawnpoints + ' spawnpoint';
    }
  } else {
    spawnpointCount = 'Number of spawnpoints unknown';
  }

  var content = '\n    <div class="nest-label">\n      <div class="nest-label-name">\n        <b>' + nest.name + '</b>\n        <a href="' + permaLink + '"><span class="fas fa-link"></span></a>\n      </div>\n      <div class="nest-label-spawnpoints">\n        (' + spawnpointCount + ')\n      </div>\n      <br/>\n      ' + allNestingPokemon + '\n    </div>';

  return new google.maps.InfoWindow({
    content: content
  });
}

function nestMigrationData(nest, migration) {
  if (nest.migrations && nest.migrations[migration] && nest.migrations[migration]['id'] > 0) {
    return nest.migrations[migration];
  }
}

function coordinateToLatLng(ooord) {
  return new google.maps.LatLng(ooord[0], ooord[1]);
}

function dateToString(date) {
  function pad(n) {
    return n < 10 ? '0' + n : n;
  }

  return pad(date.getFullYear()) + '-' + pad(date.getMonth()) + '-' + pad(date.getDate());
}

},{}]},{},[1])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJzcmMvanMvbmVzdHMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUNBQTs7QUFFQSxJQUFNLGlCQUFpQixDQUNyQixJQUFJLElBQUosQ0FBUyxJQUFULEVBQWUsQ0FBZixFQUFrQixFQUFsQixDQURxQixFQUVyQixJQUFJLElBQUosQ0FBUyxJQUFULEVBQWUsQ0FBZixFQUFrQixDQUFsQixDQUZxQixFQUdyQixJQUFJLElBQUosQ0FBUyxJQUFULEVBQWUsQ0FBZixFQUFrQixFQUFsQixDQUhxQixFQUlyQixJQUFJLElBQUosQ0FBUyxJQUFULEVBQWUsQ0FBZixFQUFrQixDQUFsQixDQUpxQixFQUtyQixJQUFJLElBQUosQ0FBUyxJQUFULEVBQWUsQ0FBZixFQUFrQixFQUFsQixDQUxxQixFQU1yQixJQUFJLElBQUosQ0FBUyxJQUFULEVBQWUsQ0FBZixFQUFrQixDQUFsQixDQU5xQixFQU9yQixJQUFJLElBQUosQ0FBUyxJQUFULEVBQWUsQ0FBZixFQUFrQixFQUFsQixDQVBxQixDQUF2Qjs7QUFVQSxJQUFNLGNBQWMsQ0FDbEIsSUFBSSxJQUFKLENBQVMsSUFBVCxFQUFlLENBQWYsRUFBa0IsRUFBbEIsQ0FEa0IsRUFFbEIsSUFBSSxJQUFKLENBQVMsSUFBVCxFQUFlLENBQWYsRUFBa0IsQ0FBbEIsQ0FGa0IsQ0FBcEI7O0FBS0EsSUFBTSxtQkFBbUIscURBQ0EscUJBRHpCOztBQUdBLE9BQU8sT0FBUCxHQUFpQixZQUFNO0FBQ3JCLE1BQU0sTUFBTSxJQUFJLE9BQU8sSUFBUCxDQUFZLEdBQWhCLENBQW9CLFNBQVMsY0FBVCxDQUF3QixLQUF4QixDQUFwQixFQUFvRDtBQUM5RCxZQUFRLFNBQVMsR0FBVCxDQUFhLFdBQWIsQ0FEc0Q7QUFFOUQsVUFBTSxTQUFTLEdBQVQsQ0FBYSxXQUFiLENBRndEO0FBRzlELHFCQUFpQixRQUg2QztBQUk5RCx1QkFBbUIsS0FKMkM7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QUNEO0FBQ0YsR0FORCxNQU1PO0FBQ0wsc0JBQWtCLCtCQUFsQjtBQUNEOztBQUVELE1BQUksK0ZBR08sS0FBSyxJQUhaLCtCQUlhLFNBSmIsb0hBT0ssZUFQTCw0Q0FVRSxpQkFWRixpQkFBSjs7QUFhQSxTQUFPLElBQUksT0FBTyxJQUFQLENBQVksVUFBaEIsQ0FBMkI7QUFDaEMsYUFBUztBQUR1QixHQUEzQixDQUFQO0FBR0Q7O0FBRUQsU0FBUyxpQkFBVCxDQUEyQixJQUEzQixFQUFpQyxTQUFqQyxFQUE0QztBQUMxQyxNQUFJLEtBQUssVUFBTCxJQUNBLEtBQUssVUFBTCxDQUFnQixTQUFoQixDQURBLElBRUMsS0FBSyxVQUFMLENBQWdCLFNBQWhCLEVBQTJCLElBQTNCLElBQW1DLENBRnhDLEVBRTRDO0FBQzFDLFdBQU8sS0FBSyxVQUFMLENBQWdCLFNBQWhCLENBQVA7QUFDRDtBQUNGOztBQUVELFNBQVMsa0JBQVQsQ0FBNEIsS0FBNUIsRUFBbUM7QUFDakMsU0FBTyxJQUFJLE9BQU8sSUFBUCxDQUFZLE1BQWhCLENBQXVCLE1BQU0sQ0FBTixDQUF2QixFQUFpQyxNQUFNLENBQU4sQ0FBakMsQ0FBUDtBQUNEOztBQUVELFNBQVMsWUFBVCxDQUFzQixJQUF0QixFQUE0QjtBQUN4QixXQUFTLEdBQVQsQ0FBYSxDQUFiLEVBQWdCO0FBQ2QsV0FBUSxJQUFJLEVBQUwsR0FBVyxNQUFNLENBQWpCLEdBQXFCLENBQTVCO0FBQ0Q7O0FBRUQsU0FBTyxJQUFJLEtBQUssV0FBTCxFQUFKLElBQTBCLEdBQTFCLEdBQ0EsSUFBSSxLQUFLLFFBQUwsRUFBSixDQURBLEdBQ3VCLEdBRHZCLEdBRUEsSUFBSSxLQUFLLE9BQUwsRUFBSixDQUZQO0FBR0giLCJmaWxlIjoiZ2VuZXJhdGVkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbigpe2Z1bmN0aW9uIHIoZSxuLHQpe2Z1bmN0aW9uIG8oaSxmKXtpZighbltpXSl7aWYoIWVbaV0pe3ZhciBjPVwiZnVuY3Rpb25cIj09dHlwZW9mIHJlcXVpcmUmJnJlcXVpcmU7aWYoIWYmJmMpcmV0dXJuIGMoaSwhMCk7aWYodSlyZXR1cm4gdShpLCEwKTt2YXIgYT1uZXcgRXJyb3IoXCJDYW5ub3QgZmluZCBtb2R1bGUgJ1wiK2krXCInXCIpO3Rocm93IGEuY29kZT1cIk1PRFVMRV9OT1RfRk9VTkRcIixhfXZhciBwPW5baV09e2V4cG9ydHM6e319O2VbaV1bMF0uY2FsbChwLmV4cG9ydHMsZnVuY3Rpb24ocil7dmFyIG49ZVtpXVsxXVtyXTtyZXR1cm4gbyhufHxyKX0scCxwLmV4cG9ydHMscixlLG4sdCl9cmV0dXJuIG5baV0uZXhwb3J0c31mb3IodmFyIHU9XCJmdW5jdGlvblwiPT10eXBlb2YgcmVxdWlyZSYmcmVxdWlyZSxpPTA7aTx0Lmxlbmd0aDtpKyspbyh0W2ldKTtyZXR1cm4gb31yZXR1cm4gcn0pKCkiLCIndXNlIHN0cmljdCc7XG5cbmNvbnN0IG1pZ3JhdGlvbkRhdGVzID0gW1xuICBuZXcgRGF0ZSgyMDE4LCA0LCAxOSksXG4gIG5ldyBEYXRlKDIwMTgsIDQsIDUpLFxuICBuZXcgRGF0ZSgyMDE4LCAzLCAyMiksXG4gIG5ldyBEYXRlKDIwMTgsIDMsIDgpLFxuICBuZXcgRGF0ZSgyMDE4LCAyLCAyMiksXG4gIG5ldyBEYXRlKDIwMTgsIDIsIDgpLFxuICBuZXcgRGF0ZSgyMDE4LCAxLCAyNSlcbl07XG5cbmNvbnN0IG5lc3RVcGRhdGVzID0gW1xuICBuZXcgRGF0ZSgyMDE4LCAzLCAzMCksXG4gIG5ldyBEYXRlKDIwMTEsIDAsIDEpXG5dO1xuXG5jb25zdCBwb2tlbW9uSW1hZ2VzVXJsID0gJ2h0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9wb2dvLWV4Y2FsaWJ1cicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICcvaW1hZ2VzL21hc3Rlci9wb2dvJztcblxud2luZG93LmluaXRNYXAgPSAoKSA9PiB7XG4gIGNvbnN0IG1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21hcCcpLCB7XG4gICAgY2VudGVyOiBTZXR0aW5ncy5nZXQoJ21hcENlbnRlcicpLFxuICAgIHpvb206IFNldHRpbmdzLmdldCgnem9vbUxldmVsJyksXG4gICAgZ2VzdHVyZUhhbmRsaW5nOiAnZ3JlZWR5JyxcbiAgICBmdWxsc2NyZWVuQ29udHJvbDogZmFsc2UsXG4gICAgc3RyZWV0Vmlld0NvbnRyb2w6IHRydWUsXG4gICAgbWFwVHlwZUNvbnRyb2w6IHRydWUsXG4gICAgY2xpY2thYmxlSWNvbnM6IGZhbHNlLFxuICAgIG1hcFR5cGVDb250cm9sT3B0aW9uczoge1xuICAgICAgc3R5bGU6IGdvb2dsZS5tYXBzLk1hcFR5cGVDb250cm9sU3R5bGUuRFJPUERPV05fTUVOVSxcbiAgICAgIHBvc2l0aW9uOiBnb29nbGUubWFwcy5Db250cm9sUG9zaXRpb24uUklHSFRfVE9QLFxuICAgICAgbWFwVHlwZUlkczogW1xuICAgICAgICBnb29nbGUubWFwcy5NYXBUeXBlSWQuUk9BRE1BUCxcbiAgICAgICAgZ29vZ2xlLm1hcHMuTWFwVHlwZUlkLlNBVEVMTElURSxcbiAgICAgICAgZ29vZ2xlLm1hcHMuTWFwVHlwZUlkLkhZQlJJRFxuICAgICAgXVxuICAgIH1cbiAgfSk7XG5cbiAgaW5pdE5lc3RzKG1hcCk7XG4gIGluaXRTZXR0aW5ncyhtYXApO1xufVxuXG5mdW5jdGlvbiBpbml0TmVzdHMobWFwKSB7XG4gIGxvYWROZXN0RGF0YSgpXG4gICAgLyogSWYgYSBuZXN0IGlzIGdpdmVuIGFzIGEgVVJMIHBhcmFtZXRlciB0aGVuIHpvb20gdG8gaXQuICovXG4gICAgLnRoZW4oZnVuY3Rpb24gKG5lc3REYXRhKSB7XG4gICAgICBjb25zdCBjZW50ZXJOZXN0TmFtZSA9IHVybFBhcmFtZXRlcignbmVzdCcpO1xuICAgICAgaWYgKGNlbnRlck5lc3ROYW1lKSB7XG4gICAgICAgIGxldCBjZW50ZXJOZXN0O1xuICAgICAgICAkLmVhY2gobmVzdERhdGEsIGZ1bmN0aW9uIChuZXN0SWQsIG5lc3QpIHtcbiAgICAgICAgICBpZiAobmVzdC5wZXJtYWxpbmtOYW1lID09IGNlbnRlck5lc3ROYW1lKSB7XG4gICAgICAgICAgICBjZW50ZXJOZXN0ID0gbmVzdDtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChjZW50ZXJOZXN0KSB7XG4gICAgICAgICAgem9vbVRvTmVzdChtYXAsIGNlbnRlck5lc3QpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBuZXN0RGF0YTtcbiAgICB9KVxuICAgIC50aGVuKGZ1bmN0aW9uIChuZXN0RGF0YSkge1xuICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFtcbiAgICAgICAgbmVzdERhdGEsXG4gICAgICAgIGxvYWRNaWdyYXRpb25EYXRhKG5lc3REYXRhKSxcbiAgICAgICAgbG9hZFBva2Vtb25EYXRhKClcbiAgICAgIF0pO1xuICAgIH0pXG4gICAgLnRoZW4oZnVuY3Rpb24gKHJlc3VsdHMpIHtcbiAgICAgIGNvbnN0IG5lc3REYXRhID0gcmVzdWx0c1swXTtcbiAgICAgIGNvbnN0IGFsbE1pZ3JhdGlvbkRhdGEgPSByZXN1bHRzWzFdO1xuICAgICAgY29uc3QgcG9rZW1vbkRhdGEgPSByZXN1bHRzWzJdO1xuXG4gICAgICAkLmVhY2goYWxsTWlncmF0aW9uRGF0YSwgZnVuY3Rpb24gKGluZGV4LCBtaWdyYXRpb25EYXRhKSB7XG4gICAgICAgIGNvbnN0IGRhdGUgPSBtaWdyYXRpb25EYXRlc1tpbmRleF07XG5cbiAgICAgICAgJC5lYWNoKG5lc3REYXRhLCBmdW5jdGlvbiAobmVzdElkLCBuZXN0KSB7XG4gICAgICAgICAgaWYgKG1pZ3JhdGlvbkRhdGFbbmVzdElkXSkge1xuICAgICAgICAgICAgaWYgKG1pZ3JhdGlvbkRhdGFbbmVzdElkXS5pZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgIGNvbnN0IHBva2VEYXRhID0gcG9rZW1vbkRhdGFbbWlncmF0aW9uRGF0YVtuZXN0SWRdXTtcbiAgICAgICAgICAgICAgbWlncmF0aW9uRGF0YVtuZXN0SWRdID0ge1xuICAgICAgICAgICAgICAgIGlkOiBtaWdyYXRpb25EYXRhW25lc3RJZF0sXG4gICAgICAgICAgICAgICAgbmFtZTogcG9rZURhdGEubmFtZVxuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIW5lc3QubWlncmF0aW9ucykge1xuICAgICAgICAgICAgICBuZXN0Lm1pZ3JhdGlvbnMgPSBbXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbmVzdC5taWdyYXRpb25zW2RhdGVdID0gbWlncmF0aW9uRGF0YVtuZXN0SWRdO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIG5lc3REYXRhO1xuICAgIH0pXG4gICAgLnRoZW4oZnVuY3Rpb24gKG5lc3REYXRhKSB7XG4gICAgICAkLmVhY2gobmVzdERhdGEsIGZ1bmN0aW9uIChuZXN0SWQsIG5lc3QpIHtcbiAgICAgICAgZHJhd05lc3QobWFwLCBuZXN0KTtcbiAgICAgIH0pO1xuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBpbml0U2V0dGluZ3MobWFwKSB7XG4gIGdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKG1hcCwgJ2lkbGUnLCBmdW5jdGlvbiAoKSB7XG4gICAgU2V0dGluZ3Muc2V0KCdtYXBDZW50ZXInLCB7XG4gICAgICBsYXQ6IG1hcC5nZXRDZW50ZXIoKS5sYXQoKSxcbiAgICAgIGxuZzogbWFwLmdldENlbnRlcigpLmxuZygpXG4gICAgfSk7XG4gICAgU2V0dGluZ3Muc2V0KCd6b29tTGV2ZWwnLCBtYXAuZ2V0Wm9vbSgpKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGxvYWROZXN0RGF0YSgpIHtcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgkLmdldEpTT04oJy9kYXRhL25lc3RzLmpzb24nKSlcbiAgICAudGhlbihmdW5jdGlvbiAobmVzdERhdGEpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoJC5nZXRKU09OKCcvZGF0YS9tYW51YWxfbmVzdHMuanNvbicpKVxuICAgICAgICAudGhlbihmdW5jdGlvbiAobWFudWFsTmVzdERhdGEpIHtcbiAgICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihuZXN0RGF0YSwgbWFudWFsTmVzdERhdGEpOztcbiAgICAgICAgfSk7XG4gICAgfSlcbiAgICAudGhlbihmdW5jdGlvbiAobmVzdERhdGEpIHtcbiAgICAgICQuZWFjaChuZXN0RGF0YSwgZnVuY3Rpb24gKG5lc3RJZCwgbmVzdCkge1xuICAgICAgICBuZXN0LmNlbnRlciA9IGNvb3JkaW5hdGVUb0xhdExuZyhuZXN0LmNlbnRlcik7XG5cbiAgICAgICAgbmVzdC5yZWdpb24gPSAkLm1hcChuZXN0LnJlZ2lvbiwgZnVuY3Rpb24gKGNvb3JkKSB7XG4gICAgICAgICAgcmV0dXJuIGNvb3JkaW5hdGVUb0xhdExuZyhjb29yZCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIG5lc3QucGVybWFsaW5rTmFtZSA9IG5lc3QubmFtZVxuICAgICAgICAgICAgLnJlcGxhY2UoL1teXFx3XS9nLCAnJylcbiAgICAgICAgICAgIC50b0xvd2VyQ2FzZSgpO1xuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiBuZXN0RGF0YTtcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gbG9hZE1pZ3JhdGlvbkRhdGEobmVzdERhdGEpIHtcbiAgcmV0dXJuIFByb21pc2UuYWxsKCQubWFwKG1pZ3JhdGlvbkRhdGVzLCBmdW5jdGlvbiAoZGF0ZSkge1xuICAgIGNvbnN0IG1pZ3JhdGlvbkZpbGUgPSBgL2RhdGEvbmVzdF9taWdyYXRpb25zLyR7ZGF0ZVRvU3RyaW5nKGRhdGUpfS5qc29uYDtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCQuZ2V0SlNPTihtaWdyYXRpb25GaWxlKSk7XG4gIH0pKVxufVxuXG5mdW5jdGlvbiBsb2FkUG9rZW1vbkRhdGEoKSB7XG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoJC5nZXRKU09OKCcvZGF0YS9wb2tlbW9uLmpzb24nKSk7XG59XG5cbmZ1bmN0aW9uIHpvb21Ub05lc3QobWFwLCBuZXN0KSB7XG4gIG1hcC5wYW5UbyhuZXN0LmNlbnRlcik7XG4gIG1hcC5zZXRab29tKDE3KTtcbn1cblxuZnVuY3Rpb24gZHJhd05lc3QobWFwLCBuZXN0KSB7XG4gIG5lc3QucG9seWdvbiA9IG5lc3RSZWdpb24obmVzdCk7XG4gIG5lc3QucG9seWdvbi5zZXRNYXAobWFwKTtcblxuICBuZXN0Lm1hcmtlciA9IG5lc3RNYXJrZXIobmVzdCk7XG4gIG5lc3QubWFya2VyLnNldE1hcChtYXApO1xuXG4gIG5lc3QubGFiZWwgPSBuZXN0TGFiZWwobmVzdCk7XG5cbiAgZnVuY3Rpb24gbGFiZWxDbGljaygpIHtcbiAgICBpZiAobmVzdC5sYWJlbC5pc09wZW4pIHtcbiAgICAgIG5lc3QubGFiZWwuY2xvc2UoKTtcbiAgICAgIG5lc3QubGFiZWwuaXNPcGVuID0gZmFsc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIG5lc3QubGFiZWwuc2V0UG9zaXRpb24obmVzdC5jZW50ZXIpO1xuICAgICAgbmVzdC5sYWJlbC5vcGVuKG1hcCk7XG4gICAgICBuZXN0LmxhYmVsLmlzT3BlbiA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgbmVzdC5sYWJlbC5pc09wZW4gPSBmYWxzZTtcblxuICBuZXN0LnBvbHlnb24uYWRkTGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gKCkge1xuICAgIGxhYmVsQ2xpY2soKTtcbiAgfSk7XG5cbiAgbmVzdC5tYXJrZXIuYWRkTGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gKCkge1xuICAgIGxhYmVsQ2xpY2soKTtcbiAgfSk7XG5cbiAgbWFwLmFkZExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uICgpIHtcbiAgICBuZXN0LmxhYmVsLmNsb3NlKCk7XG4gICAgbmVzdC5sYWJlbC5pc09wZW4gPSBmYWxzZTtcbiAgfSk7XG5cbiAgbmVzdC5sYWJlbC5hZGRMaXN0ZW5lcignY2xvc2VjbGljaycsIGZ1bmN0aW9uICgpIHtcbiAgICBuZXN0LmxhYmVsLmlzT3BlbiA9IGZhbHNlO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gbmVzdFJlZ2lvbihuZXN0KSB7XG4gIGxldCBuZXN0Q29sb3IgPSAnZ3JlZW4nO1xuICBpZiAobmVzdC5kYXRlX2FkZGVkID09IGRhdGVUb1N0cmluZyhuZXN0VXBkYXRlc1swXSkpIHtcbiAgICBuZXN0Q29sb3IgPSAnYmx1ZSc7XG4gIH1cblxuICByZXR1cm4gbmV3IGdvb2dsZS5tYXBzLlBvbHlnb24oe1xuICAgIHBhdGhzOiBuZXN0LnJlZ2lvbixcbiAgICBmaWxsQ29sb3I6IG5lc3RDb2xvcixcbiAgICBmaWxsT3BhY2l0eTogMC41LFxuICAgIHN0cm9rZUNvbG9yOiBuZXN0Q29sb3IsXG4gICAgc3Ryb2tlT3BhY2l0eTogMSxcbiAgICBzdHJva2VXZWlnaHQ6IDBcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIG5lc3RNYXJrZXIobmVzdCkge1xuICBjb25zdCBpY29uID0gbmVzdEljb24obmVzdCk7XG5cbiAgaWYgKGljb24pIHtcbiAgICByZXR1cm4gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7XG4gICAgICBwb3NpdGlvbjogbmVzdC5jZW50ZXIsXG4gICAgICBpY29uOiBuZXN0SWNvbihuZXN0KVxuICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBuZXcgZ29vZ2xlLm1hcHMuTWFya2VyKCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gbmVzdEljb24obmVzdCkge1xuICBjb25zdCBuZXN0UG9rZW1vbiA9IG5lc3RNaWdyYXRpb25EYXRhKG5lc3QsIG1pZ3JhdGlvbkRhdGVzWzBdKTtcblxuICBpZiAobmVzdFBva2Vtb24pIHtcbiAgICByZXR1cm4ge1xuICAgICAgdXJsOiBgJHtwb2tlbW9uSW1hZ2VzVXJsfS8ke25lc3RQb2tlbW9uLmlkfS5wbmdgLFxuICAgICAgc2NhbGVkU2l6ZTogbmV3IGdvb2dsZS5tYXBzLlNpemUoMzQsIDM0KSxcbiAgICAgIGFuY2hvcjogbmV3IGdvb2dsZS5tYXBzLlBvaW50KDE3LCAxNylcbiAgICB9O1xuICB9XG59XG5cbmZ1bmN0aW9uIG5lc3RMYWJlbChuZXN0KSB7XG4gIGZ1bmN0aW9uIHBva2Vtb25OYW1lU3RyKHBva2Vtb24pIHtcbiAgICByZXR1cm4gcG9rZW1vbiA/IGAke3Bva2Vtb24ubmFtZX0gKCMke3Bva2Vtb24uaWR9KWAgOiAnPyc7XG4gIH1cblxuICBjb25zdCBhbGxOZXN0aW5nUG9rZW1vbiA9ICQubWFwKG1pZ3JhdGlvbkRhdGVzLCBmdW5jdGlvbiAoZGF0ZSwgaW5kZXgpIHtcbiAgICBjb25zdCBkYXRlU3RyID0gKGluZGV4ID09IDApID8gJ0N1cnJlbnQnIDogZGF0ZVRvU3RyaW5nKGRhdGUpO1xuICAgIGNvbnN0IHBva2Vtb24gPSBuZXN0TWlncmF0aW9uRGF0YShuZXN0LCBkYXRlKTtcblxuICAgIHJldHVybiBgXG4gICAgICA8ZGl2IGNsYXNzPVwibmVzdC1sYWJlbC1wb2tlbW9uXCI+XG4gICAgICAgICR7ZGF0ZVN0cn06ICR7cG9rZW1vbk5hbWVTdHIocG9rZW1vbil9XG4gICAgICA8L2Rpdj5gO1xuICB9KS5qb2luKCdcXG4nKTtcblxuICBjb25zdCBiYXNlVVJMID0gbG9jYXRpb24ucHJvdG9jb2wgKyAnLy8nICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lO1xuICBjb25zdCBwZXJtYUxpbmsgPSBgJHtiYXNlVVJMfT9uZXN0PSR7bmVzdC5wZXJtYWxpbmtOYW1lfWA7XG5cbiAgbGV0IHNwYXducG9pbnRDb3VudFxuICBpZiAobmVzdC5zcGF3bnBvaW50cykge1xuICAgIGlmIChuZXN0LnNwYXducG9pbnRzID4gMSkge1xuICAgICAgc3Bhd25wb2ludENvdW50ID0gYCR7bmVzdC5zcGF3bnBvaW50c30gc3Bhd25wb2ludHNgO1xuICAgIH0gZWxzZSB7XG4gICAgICBzcGF3bnBvaW50Q291bnQgPSBgJHtuZXN0LnNwYXducG9pbnRzfSBzcGF3bnBvaW50YDtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgc3Bhd25wb2ludENvdW50ID0gJ051bWJlciBvZiBzcGF3bnBvaW50cyB1bmtub3duJztcbiAgfVxuXG4gIGxldCBjb250ZW50ID0gYFxuICAgIDxkaXYgY2xhc3M9XCJuZXN0LWxhYmVsXCI+XG4gICAgICA8ZGl2IGNsYXNzPVwibmVzdC1sYWJlbC1uYW1lXCI+XG4gICAgICAgIDxiPiR7bmVzdC5uYW1lfTwvYj5cbiAgICAgICAgPGEgaHJlZj1cIiR7cGVybWFMaW5rfVwiPjxzcGFuIGNsYXNzPVwiZmFzIGZhLWxpbmtcIj48L3NwYW4+PC9hPlxuICAgICAgPC9kaXY+XG4gICAgICA8ZGl2IGNsYXNzPVwibmVzdC1sYWJlbC1zcGF3bnBvaW50c1wiPlxuICAgICAgICAoJHtzcGF3bnBvaW50Q291bnR9KVxuICAgICAgPC9kaXY+XG4gICAgICA8YnIvPlxuICAgICAgJHthbGxOZXN0aW5nUG9rZW1vbn1cbiAgICA8L2Rpdj5gO1xuXG4gIHJldHVybiBuZXcgZ29vZ2xlLm1hcHMuSW5mb1dpbmRvdyh7XG4gICAgY29udGVudDogY29udGVudFxuICB9KTtcbn1cblxuZnVuY3Rpb24gbmVzdE1pZ3JhdGlvbkRhdGEobmVzdCwgbWlncmF0aW9uKSB7XG4gIGlmIChuZXN0Lm1pZ3JhdGlvbnMgJiZcbiAgICAgIG5lc3QubWlncmF0aW9uc1ttaWdyYXRpb25dICYmXG4gICAgICAobmVzdC5taWdyYXRpb25zW21pZ3JhdGlvbl1bJ2lkJ10gPiAwKSkge1xuICAgIHJldHVybiBuZXN0Lm1pZ3JhdGlvbnNbbWlncmF0aW9uXTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjb29yZGluYXRlVG9MYXRMbmcob29vcmQpIHtcbiAgcmV0dXJuIG5ldyBnb29nbGUubWFwcy5MYXRMbmcob29vcmRbMF0sIG9vb3JkWzFdKTtcbn1cblxuZnVuY3Rpb24gZGF0ZVRvU3RyaW5nKGRhdGUpIHtcbiAgICBmdW5jdGlvbiBwYWQobikge1xuICAgICAgcmV0dXJuIChuIDwgMTApID8gJzAnICsgbiA6IG47XG4gICAgfVxuXG4gICAgcmV0dXJuIHBhZChkYXRlLmdldEZ1bGxZZWFyKCkpICsgJy0nICtcbiAgICAgICAgICAgcGFkKGRhdGUuZ2V0TW9udGgoKSkgKyAnLScgK1xuICAgICAgICAgICBwYWQoZGF0ZS5nZXREYXRlKCkpO1xufVxuIl19
