(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
'use strict';

var migrationDates = [new Date(2018, 4, 19), new Date(2018, 4, 5), new Date(2018, 3, 22), new Date(2018, 3, 8), new Date(2018, 2, 22), new Date(2018, 2, 8), new Date(2018, 1, 25)];

var nestUpdates = [new Date(2018, 3, 30), new Date(2011, 0, 1)];

var pokemonImagesUrl = 'https://raw.githubusercontent.com/pogo-excalibur' + '/images/master/pogo';

window.initMap = function () {
  var map = new google.maps.Map(document.getElementById('map'), {
    center: Settings.get('mapCenter'),
    zoom: Settings.get('zoomLevel'),
    gestureHandling: 'greedy',
    fullscreenControl: false,
    streetViewControl: true,
    mapTypeControl: true,
    clickableIcons: false,
    mapTypeControlOptions: {
      style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
      position: google.maps.ControlPosition.RIGHT_TOP,
      mapTypeIds: [google.maps.MapTypeId.ROADMAP, google.maps.MapTypeId.SATELLITE, google.maps.MapTypeId.HYBRID]
    }
  });

  initNests(map);
  initSettings(map);
};

function initNests(map) {
  loadNestData()
  /* If a nest is given as a URL parameter then zoom to it. */
  .then(function (nestData) {
    var centerNestName = urlParameter('nest');
    if (centerNestName) {
      var centerNest = void 0;
      $.each(nestData, function (nestId, nest) {
        if (nest.permalinkName == centerNestName) {
          centerNest = nest;
          return false;
        }
      });

      if (centerNest) {
        zoomToNest(map, centerNest);
      }
    }

    return nestData;
  }).then(function (nestData) {
    return Promise.all([nestData, loadMigrationData(nestData), loadPokemonData()]);
  }).then(function (results) {
    var nestData = results[0];
    var allMigrationData = results[1];
    var pokemonData = results[2];

    $.each(allMigrationData, function (index, migrationData) {
      var date = migrationDates[index];

      $.each(nestData, function (nestId, nest) {
        if (migrationData[nestId]) {
          if (migrationData[nestId].id === undefined) {
            var pokeData = pokemonData[migrationData[nestId]];
            migrationData[nestId] = {
              id: migrationData[nestId],
              name: pokeData.name
            };
          }

          if (!nest.migrations) {
            nest.migrations = [];
          }

          nest.migrations[date] = migrationData[nestId];
        }
      });
    });

    return nestData;
  }).then(function (nestData) {
    $.each(nestData, function (nestId, nest) {
      drawNest(map, nest);
    });
  });
}

function initSettings(map) {
  google.maps.event.addListener(map, 'idle', function () {
    Settings.set('mapCenter', {
      lat: map.getCenter().lat(),
      lng: map.getCenter().lng()
    });
    Settings.set('zoomLevel', map.getZoom());
  });
}

function loadNestData() {
  return Promise.resolve($.getJSON('/data/nests.json')).then(function (nestData) {
    return Promise.resolve($.getJSON('/data/manual_nests.json')).then(function (manualNestData) {
      return Object.assign(nestData, manualNestData);;
    });
  }).then(function (nestData) {
    $.each(nestData, function (nestId, nest) {
      nest.center = coordinateToLatLng(nest.center);

      nest.region = $.map(nest.region, function (coord) {
        return coordinateToLatLng(coord);
      });

      nest.permalinkName = nest.name.replace(/[^\w]/g, '').toLowerCase();
    });

    return nestData;
  });
}

function loadMigrationData(nestData) {
  return Promise.all($.map(migrationDates, function (date) {
    var migrationFile = '/data/nest_migrations/' + dateToString(date) + '.json';
    return Promise.resolve($.getJSON(migrationFile));
  }));
}

function loadPokemonData() {
  return Promise.resolve($.getJSON('/data/pokemon.json'));
}

function zoomToNest(map, nest) {
  map.panTo(nest.center);
  map.setZoom(17);
}

function drawNest(map, nest) {
  nest.polygon = nestRegion(nest);
  nest.polygon.setMap(map);

  nest.marker = nestMarker(nest);
  nest.marker.setMap(map);

  nest.label = nestLabel(nest);

  function labelClick() {
    if (nest.label.isOpen) {
      nest.label.close();
      nest.label.isOpen = false;
    } else {
      nest.label.setPosition(nest.center);
      nest.label.open(map);
      nest.label.isOpen = true;
    }
  }

  nest.label.isOpen = false;

  nest.polygon.addListener('click', function () {
    labelClick();
  });

  nest.marker.addListener('click', function () {
    labelClick();
  });

  map.addListener('click', function () {
    nest.label.close();
    nest.label.isOpen = false;
  });

  nest.label.addListener('closeclick', function () {
    nest.label.isOpen = false;
  });
}

function nestRegion(nest) {
  var nestColor = 'green';
  if (nest.date_added == dateToString(nestUpdates[0])) {
    nestColor = 'blue';
  }

  return new google.maps.Polygon({
    paths: nest.region,
    fillColor: nestColor,
    fillOpacity: 0.5,
    strokeColor: nestColor,
    strokeOpacity: 1,
    strokeWeight: 0
  });
}

function nestMarker(nest) {
  var icon = nestIcon(nest);

  if (icon) {
    return new google.maps.Marker({
      position: nest.center,
      icon: nestIcon(nest)
    });
  } else {
    return new google.maps.Marker();
  }
}

function nestIcon(nest) {
  var nestPokemon = nestMigrationData(nest, migrationDates[0]);

  if (nestPokemon) {
    return {
      url: pokemonImagesUrl + '/' + nestPokemon.id + '.png',
      scaledSize: new google.maps.Size(34, 34),
      anchor: new google.maps.Point(17, 17)
    };
  }
}

function nestLabel(nest) {
  function pokemonNameStr(pokemon) {
    return pokemon ? pokemon.name + ' (#' + pokemon.id + ')' : '?';
  }

  var allNestingPokemon = $.map(migrationDates, function (date, index) {
    var dateStr = index == 0 ? 'Current' : dateToString(date);
    var pokemon = nestMigrationData(nest, date);

    return '\n      <div class="nest-label-pokemon">\n        ' + dateStr + ': ' + pokemonNameStr(pokemon) + '\n      </div>';
  }).join('\n');

  var baseURL = location.protocol + '//' + location.host + location.pathname;
  var permaLink = baseURL + '?nest=' + nest.permalinkName;

  var spawnpointCount = void 0;
  if (nest.spawnpoints) {
    if (nest.spawnpoints > 1) {
      spawnpointCount = nest.spawnpoints + ' spawnpoints';
    } else {
      spawnpointCount = nest.spawnpoints + ' spawnpoint';
    }
  } else {
    spawnpointCount = 'Number of spawnpoints unknown';
  }

  var content = '\n    <div class="nest-label">\n      <div class="nest-label-name">\n        <b>' + nest.name + '</b>\n        <a href="' + permaLink + '"><span class="fas fa-link"></span></a>\n      </div>\n      <div class="nest-label-spawnpoints">\n        (' + spawnpointCount + ')\n      </div>\n      <br/>\n      ' + allNestingPokemon + '\n    </div>';

  return new google.maps.InfoWindow({
    content: content
  });
}

function nestMigrationData(nest, migration) {
  if (nest.migrations && nest.migrations[migration] && nest.migrations[migration]['id'] > 0) {
    return nest.migrations[migration];
  }
}

function coordinateToLatLng(ooord) {
  return new google.maps.LatLng(ooord[0], ooord[1]);
}

function dateToString(date) {
  function pad(n) {
    return n < 10 ? '0' + n : n;
  }

  return pad(date.getFullYear()) + '-' + pad(date.getMonth()) + '-' + pad(date.getDate());
}

},{}]},{},[1])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJzcmMvanMvbmVzdHMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztBQ0FBLElBQU0saUJBQWlCLENBQ3JCLElBQUksSUFBSixDQUFTLElBQVQsRUFBZSxDQUFmLEVBQWtCLEVBQWxCLENBRHFCLEVBRXJCLElBQUksSUFBSixDQUFTLElBQVQsRUFBZSxDQUFmLEVBQWtCLENBQWxCLENBRnFCLEVBR3JCLElBQUksSUFBSixDQUFTLElBQVQsRUFBZSxDQUFmLEVBQWtCLEVBQWxCLENBSHFCLEVBSXJCLElBQUksSUFBSixDQUFTLElBQVQsRUFBZSxDQUFmLEVBQWtCLENBQWxCLENBSnFCLEVBS3JCLElBQUksSUFBSixDQUFTLElBQVQsRUFBZSxDQUFmLEVBQWtCLEVBQWxCLENBTHFCLEVBTXJCLElBQUksSUFBSixDQUFTLElBQVQsRUFBZSxDQUFmLEVBQWtCLENBQWxCLENBTnFCLEVBT3JCLElBQUksSUFBSixDQUFTLElBQVQsRUFBZSxDQUFmLEVBQWtCLEVBQWxCLENBUHFCLENBQXZCOztBQVVBLElBQU0sY0FBYyxDQUNsQixJQUFJLElBQUosQ0FBUyxJQUFULEVBQWUsQ0FBZixFQUFrQixFQUFsQixDQURrQixFQUVsQixJQUFJLElBQUosQ0FBUyxJQUFULEVBQWUsQ0FBZixFQUFrQixDQUFsQixDQUZrQixDQUFwQjs7QUFLQSxJQUFNLG1CQUFtQixxREFDQSxxQkFEekI7O0FBR0EsT0FBTyxPQUFQLEdBQWlCLFlBQU07QUFDckIsTUFBTSxNQUFNLElBQUksT0FBTyxJQUFQLENBQVksR0FBaEIsQ0FBb0IsU0FBUyxjQUFULENBQXdCLEtBQXhCLENBQXBCLEVBQW9EO0FBQzlELFlBQVEsU0FBUyxHQUFULENBQWEsV0FBYixDQURzRDtBQUU5RCxVQUFNLFNBQVMsR0FBVCxDQUFhLFdBQWIsQ0FGd0Q7QUFHOUQscUJBQWlCLFFBSDZDO0FBSTlELHVCQUFtQixLQUoyQztBQUs5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QUFDRixHQU5ELE1BTU87QUFDTCxzQkFBa0IsK0JBQWxCO0FBQ0Q7O0FBRUQsTUFBSSwrRkFHTyxLQUFLLElBSFosK0JBSWEsU0FKYixvSEFPSyxlQVBMLDRDQVVFLGlCQVZGLGlCQUFKOztBQWFBLFNBQU8sSUFBSSxPQUFPLElBQVAsQ0FBWSxVQUFoQixDQUEyQjtBQUNoQyxhQUFTO0FBRHVCLEdBQTNCLENBQVA7QUFHRDs7QUFFRCxTQUFTLGlCQUFULENBQTJCLElBQTNCLEVBQWlDLFNBQWpDLEVBQTRDO0FBQzFDLE1BQUksS0FBSyxVQUFMLElBQ0EsS0FBSyxVQUFMLENBQWdCLFNBQWhCLENBREEsSUFFQyxLQUFLLFVBQUwsQ0FBZ0IsU0FBaEIsRUFBMkIsSUFBM0IsSUFBbUMsQ0FGeEMsRUFFNEM7QUFDMUMsV0FBTyxLQUFLLFVBQUwsQ0FBZ0IsU0FBaEIsQ0FBUDtBQUNEO0FBQ0Y7O0FBRUQsU0FBUyxrQkFBVCxDQUE0QixLQUE1QixFQUFtQztBQUNqQyxTQUFPLElBQUksT0FBTyxJQUFQLENBQVksTUFBaEIsQ0FBdUIsTUFBTSxDQUFOLENBQXZCLEVBQWlDLE1BQU0sQ0FBTixDQUFqQyxDQUFQO0FBQ0Q7O0FBRUQsU0FBUyxZQUFULENBQXNCLElBQXRCLEVBQTRCO0FBQ3hCLFdBQVMsR0FBVCxDQUFhLENBQWIsRUFBZ0I7QUFDZCxXQUFRLElBQUksRUFBTCxHQUFXLE1BQU0sQ0FBakIsR0FBcUIsQ0FBNUI7QUFDRDs7QUFFRCxTQUFPLElBQUksS0FBSyxXQUFMLEVBQUosSUFBMEIsR0FBMUIsR0FDQSxJQUFJLEtBQUssUUFBTCxFQUFKLENBREEsR0FDdUIsR0FEdkIsR0FFQSxJQUFJLEtBQUssT0FBTCxFQUFKLENBRlA7QUFHSCIsImZpbGUiOiJnZW5lcmF0ZWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uKCl7ZnVuY3Rpb24gcihlLG4sdCl7ZnVuY3Rpb24gbyhpLGYpe2lmKCFuW2ldKXtpZighZVtpXSl7dmFyIGM9XCJmdW5jdGlvblwiPT10eXBlb2YgcmVxdWlyZSYmcmVxdWlyZTtpZighZiYmYylyZXR1cm4gYyhpLCEwKTtpZih1KXJldHVybiB1KGksITApO3ZhciBhPW5ldyBFcnJvcihcIkNhbm5vdCBmaW5kIG1vZHVsZSAnXCIraStcIidcIik7dGhyb3cgYS5jb2RlPVwiTU9EVUxFX05PVF9GT1VORFwiLGF9dmFyIHA9bltpXT17ZXhwb3J0czp7fX07ZVtpXVswXS5jYWxsKHAuZXhwb3J0cyxmdW5jdGlvbihyKXt2YXIgbj1lW2ldWzFdW3JdO3JldHVybiBvKG58fHIpfSxwLHAuZXhwb3J0cyxyLGUsbix0KX1yZXR1cm4gbltpXS5leHBvcnRzfWZvcih2YXIgdT1cImZ1bmN0aW9uXCI9PXR5cGVvZiByZXF1aXJlJiZyZXF1aXJlLGk9MDtpPHQubGVuZ3RoO2krKylvKHRbaV0pO3JldHVybiBvfXJldHVybiByfSkoKSIsImNvbnN0IG1pZ3JhdGlvbkRhdGVzID0gW1xuICBuZXcgRGF0ZSgyMDE4LCA0LCAxOSksXG4gIG5ldyBEYXRlKDIwMTgsIDQsIDUpLFxuICBuZXcgRGF0ZSgyMDE4LCAzLCAyMiksXG4gIG5ldyBEYXRlKDIwMTgsIDMsIDgpLFxuICBuZXcgRGF0ZSgyMDE4LCAyLCAyMiksXG4gIG5ldyBEYXRlKDIwMTgsIDIsIDgpLFxuICBuZXcgRGF0ZSgyMDE4LCAxLCAyNSlcbl07XG5cbmNvbnN0IG5lc3RVcGRhdGVzID0gW1xuICBuZXcgRGF0ZSgyMDE4LCAzLCAzMCksXG4gIG5ldyBEYXRlKDIwMTEsIDAsIDEpXG5dO1xuXG5jb25zdCBwb2tlbW9uSW1hZ2VzVXJsID0gJ2h0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9wb2dvLWV4Y2FsaWJ1cicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICcvaW1hZ2VzL21hc3Rlci9wb2dvJztcblxud2luZG93LmluaXRNYXAgPSAoKSA9PiB7XG4gIGNvbnN0IG1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21hcCcpLCB7XG4gICAgY2VudGVyOiBTZXR0aW5ncy5nZXQoJ21hcENlbnRlcicpLFxuICAgIHpvb206IFNldHRpbmdzLmdldCgnem9vbUxldmVsJyksXG4gICAgZ2VzdHVyZUhhbmRsaW5nOiAnZ3JlZWR5JyxcbiAgICBmdWxsc2NyZWVuQ29udHJvbDogZmFsc2UsXG4gICAgc3RyZWV0Vmlld0NvbnRyb2w6IHRydWUsXG4gICAgbWFwVHlwZUNvbnRyb2w6IHRydWUsXG4gICAgY2xpY2thYmxlSWNvbnM6IGZhbHNlLFxuICAgIG1hcFR5cGVDb250cm9sT3B0aW9uczoge1xuICAgICAgc3R5bGU6IGdvb2dsZS5tYXBzLk1hcFR5cGVDb250cm9sU3R5bGUuRFJPUERPV05fTUVOVSxcbiAgICAgIHBvc2l0aW9uOiBnb29nbGUubWFwcy5Db250cm9sUG9zaXRpb24uUklHSFRfVE9QLFxuICAgICAgbWFwVHlwZUlkczogW1xuICAgICAgICBnb29nbGUubWFwcy5NYXBUeXBlSWQuUk9BRE1BUCxcbiAgICAgICAgZ29vZ2xlLm1hcHMuTWFwVHlwZUlkLlNBVEVMTElURSxcbiAgICAgICAgZ29vZ2xlLm1hcHMuTWFwVHlwZUlkLkhZQlJJRFxuICAgICAgXVxuICAgIH1cbiAgfSk7XG5cbiAgaW5pdE5lc3RzKG1hcCk7XG4gIGluaXRTZXR0aW5ncyhtYXApO1xufVxuXG5mdW5jdGlvbiBpbml0TmVzdHMobWFwKSB7XG4gIGxvYWROZXN0RGF0YSgpXG4gICAgLyogSWYgYSBuZXN0IGlzIGdpdmVuIGFzIGEgVVJMIHBhcmFtZXRlciB0aGVuIHpvb20gdG8gaXQuICovXG4gICAgLnRoZW4oZnVuY3Rpb24gKG5lc3REYXRhKSB7XG4gICAgICBjb25zdCBjZW50ZXJOZXN0TmFtZSA9IHVybFBhcmFtZXRlcignbmVzdCcpO1xuICAgICAgaWYgKGNlbnRlck5lc3ROYW1lKSB7XG4gICAgICAgIGxldCBjZW50ZXJOZXN0O1xuICAgICAgICAkLmVhY2gobmVzdERhdGEsIGZ1bmN0aW9uIChuZXN0SWQsIG5lc3QpIHtcbiAgICAgICAgICBpZiAobmVzdC5wZXJtYWxpbmtOYW1lID09IGNlbnRlck5lc3ROYW1lKSB7XG4gICAgICAgICAgICBjZW50ZXJOZXN0ID0gbmVzdDtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChjZW50ZXJOZXN0KSB7XG4gICAgICAgICAgem9vbVRvTmVzdChtYXAsIGNlbnRlck5lc3QpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBuZXN0RGF0YTtcbiAgICB9KVxuICAgIC50aGVuKGZ1bmN0aW9uIChuZXN0RGF0YSkge1xuICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFtcbiAgICAgICAgbmVzdERhdGEsXG4gICAgICAgIGxvYWRNaWdyYXRpb25EYXRhKG5lc3REYXRhKSxcbiAgICAgICAgbG9hZFBva2Vtb25EYXRhKClcbiAgICAgIF0pO1xuICAgIH0pXG4gICAgLnRoZW4oZnVuY3Rpb24gKHJlc3VsdHMpIHtcbiAgICAgIGNvbnN0IG5lc3REYXRhID0gcmVzdWx0c1swXTtcbiAgICAgIGNvbnN0IGFsbE1pZ3JhdGlvbkRhdGEgPSByZXN1bHRzWzFdO1xuICAgICAgY29uc3QgcG9rZW1vbkRhdGEgPSByZXN1bHRzWzJdO1xuXG4gICAgICAkLmVhY2goYWxsTWlncmF0aW9uRGF0YSwgZnVuY3Rpb24gKGluZGV4LCBtaWdyYXRpb25EYXRhKSB7XG4gICAgICAgIGNvbnN0IGRhdGUgPSBtaWdyYXRpb25EYXRlc1tpbmRleF07XG5cbiAgICAgICAgJC5lYWNoKG5lc3REYXRhLCBmdW5jdGlvbiAobmVzdElkLCBuZXN0KSB7XG4gICAgICAgICAgaWYgKG1pZ3JhdGlvbkRhdGFbbmVzdElkXSkge1xuICAgICAgICAgICAgaWYgKG1pZ3JhdGlvbkRhdGFbbmVzdElkXS5pZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgIGNvbnN0IHBva2VEYXRhID0gcG9rZW1vbkRhdGFbbWlncmF0aW9uRGF0YVtuZXN0SWRdXTtcbiAgICAgICAgICAgICAgbWlncmF0aW9uRGF0YVtuZXN0SWRdID0ge1xuICAgICAgICAgICAgICAgIGlkOiBtaWdyYXRpb25EYXRhW25lc3RJZF0sXG4gICAgICAgICAgICAgICAgbmFtZTogcG9rZURhdGEubmFtZVxuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIW5lc3QubWlncmF0aW9ucykge1xuICAgICAgICAgICAgICBuZXN0Lm1pZ3JhdGlvbnMgPSBbXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbmVzdC5taWdyYXRpb25zW2RhdGVdID0gbWlncmF0aW9uRGF0YVtuZXN0SWRdO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIG5lc3REYXRhO1xuICAgIH0pXG4gICAgLnRoZW4oZnVuY3Rpb24gKG5lc3REYXRhKSB7XG4gICAgICAkLmVhY2gobmVzdERhdGEsIGZ1bmN0aW9uIChuZXN0SWQsIG5lc3QpIHtcbiAgICAgICAgZHJhd05lc3QobWFwLCBuZXN0KTtcbiAgICAgIH0pO1xuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBpbml0U2V0dGluZ3MobWFwKSB7XG4gIGdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKG1hcCwgJ2lkbGUnLCBmdW5jdGlvbiAoKSB7XG4gICAgU2V0dGluZ3Muc2V0KCdtYXBDZW50ZXInLCB7XG4gICAgICBsYXQ6IG1hcC5nZXRDZW50ZXIoKS5sYXQoKSxcbiAgICAgIGxuZzogbWFwLmdldENlbnRlcigpLmxuZygpXG4gICAgfSk7XG4gICAgU2V0dGluZ3Muc2V0KCd6b29tTGV2ZWwnLCBtYXAuZ2V0Wm9vbSgpKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGxvYWROZXN0RGF0YSgpIHtcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgkLmdldEpTT04oJy9kYXRhL25lc3RzLmpzb24nKSlcbiAgICAudGhlbihmdW5jdGlvbiAobmVzdERhdGEpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoJC5nZXRKU09OKCcvZGF0YS9tYW51YWxfbmVzdHMuanNvbicpKVxuICAgICAgICAudGhlbihmdW5jdGlvbiAobWFudWFsTmVzdERhdGEpIHtcbiAgICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihuZXN0RGF0YSwgbWFudWFsTmVzdERhdGEpOztcbiAgICAgICAgfSk7XG4gICAgfSlcbiAgICAudGhlbihmdW5jdGlvbiAobmVzdERhdGEpIHtcbiAgICAgICQuZWFjaChuZXN0RGF0YSwgZnVuY3Rpb24gKG5lc3RJZCwgbmVzdCkge1xuICAgICAgICBuZXN0LmNlbnRlciA9IGNvb3JkaW5hdGVUb0xhdExuZyhuZXN0LmNlbnRlcik7XG5cbiAgICAgICAgbmVzdC5yZWdpb24gPSAkLm1hcChuZXN0LnJlZ2lvbiwgZnVuY3Rpb24gKGNvb3JkKSB7XG4gICAgICAgICAgcmV0dXJuIGNvb3JkaW5hdGVUb0xhdExuZyhjb29yZCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIG5lc3QucGVybWFsaW5rTmFtZSA9IG5lc3QubmFtZVxuICAgICAgICAgICAgLnJlcGxhY2UoL1teXFx3XS9nLCAnJylcbiAgICAgICAgICAgIC50b0xvd2VyQ2FzZSgpO1xuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiBuZXN0RGF0YTtcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gbG9hZE1pZ3JhdGlvbkRhdGEobmVzdERhdGEpIHtcbiAgcmV0dXJuIFByb21pc2UuYWxsKCQubWFwKG1pZ3JhdGlvbkRhdGVzLCBmdW5jdGlvbiAoZGF0ZSkge1xuICAgIGNvbnN0IG1pZ3JhdGlvbkZpbGUgPSBgL2RhdGEvbmVzdF9taWdyYXRpb25zLyR7ZGF0ZVRvU3RyaW5nKGRhdGUpfS5qc29uYDtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCQuZ2V0SlNPTihtaWdyYXRpb25GaWxlKSk7XG4gIH0pKVxufVxuXG5mdW5jdGlvbiBsb2FkUG9rZW1vbkRhdGEoKSB7XG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoJC5nZXRKU09OKCcvZGF0YS9wb2tlbW9uLmpzb24nKSk7XG59XG5cbmZ1bmN0aW9uIHpvb21Ub05lc3QobWFwLCBuZXN0KSB7XG4gIG1hcC5wYW5UbyhuZXN0LmNlbnRlcik7XG4gIG1hcC5zZXRab29tKDE3KTtcbn1cblxuZnVuY3Rpb24gZHJhd05lc3QobWFwLCBuZXN0KSB7XG4gIG5lc3QucG9seWdvbiA9IG5lc3RSZWdpb24obmVzdCk7XG4gIG5lc3QucG9seWdvbi5zZXRNYXAobWFwKTtcblxuICBuZXN0Lm1hcmtlciA9IG5lc3RNYXJrZXIobmVzdCk7XG4gIG5lc3QubWFya2VyLnNldE1hcChtYXApO1xuXG4gIG5lc3QubGFiZWwgPSBuZXN0TGFiZWwobmVzdCk7XG5cbiAgZnVuY3Rpb24gbGFiZWxDbGljaygpIHtcbiAgICBpZiAobmVzdC5sYWJlbC5pc09wZW4pIHtcbiAgICAgIG5lc3QubGFiZWwuY2xvc2UoKTtcbiAgICAgIG5lc3QubGFiZWwuaXNPcGVuID0gZmFsc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIG5lc3QubGFiZWwuc2V0UG9zaXRpb24obmVzdC5jZW50ZXIpO1xuICAgICAgbmVzdC5sYWJlbC5vcGVuKG1hcCk7XG4gICAgICBuZXN0LmxhYmVsLmlzT3BlbiA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgbmVzdC5sYWJlbC5pc09wZW4gPSBmYWxzZTtcblxuICBuZXN0LnBvbHlnb24uYWRkTGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gKCkge1xuICAgIGxhYmVsQ2xpY2soKTtcbiAgfSk7XG5cbiAgbmVzdC5tYXJrZXIuYWRkTGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gKCkge1xuICAgIGxhYmVsQ2xpY2soKTtcbiAgfSk7XG5cbiAgbWFwLmFkZExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uICgpIHtcbiAgICBuZXN0LmxhYmVsLmNsb3NlKCk7XG4gICAgbmVzdC5sYWJlbC5pc09wZW4gPSBmYWxzZTtcbiAgfSk7XG5cbiAgbmVzdC5sYWJlbC5hZGRMaXN0ZW5lcignY2xvc2VjbGljaycsIGZ1bmN0aW9uICgpIHtcbiAgICBuZXN0LmxhYmVsLmlzT3BlbiA9IGZhbHNlO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gbmVzdFJlZ2lvbihuZXN0KSB7XG4gIGxldCBuZXN0Q29sb3IgPSAnZ3JlZW4nO1xuICBpZiAobmVzdC5kYXRlX2FkZGVkID09IGRhdGVUb1N0cmluZyhuZXN0VXBkYXRlc1swXSkpIHtcbiAgICBuZXN0Q29sb3IgPSAnYmx1ZSc7XG4gIH1cblxuICByZXR1cm4gbmV3IGdvb2dsZS5tYXBzLlBvbHlnb24oe1xuICAgIHBhdGhzOiBuZXN0LnJlZ2lvbixcbiAgICBmaWxsQ29sb3I6IG5lc3RDb2xvcixcbiAgICBmaWxsT3BhY2l0eTogMC41LFxuICAgIHN0cm9rZUNvbG9yOiBuZXN0Q29sb3IsXG4gICAgc3Ryb2tlT3BhY2l0eTogMSxcbiAgICBzdHJva2VXZWlnaHQ6IDBcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIG5lc3RNYXJrZXIobmVzdCkge1xuICBjb25zdCBpY29uID0gbmVzdEljb24obmVzdCk7XG5cbiAgaWYgKGljb24pIHtcbiAgICByZXR1cm4gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7XG4gICAgICBwb3NpdGlvbjogbmVzdC5jZW50ZXIsXG4gICAgICBpY29uOiBuZXN0SWNvbihuZXN0KVxuICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBuZXcgZ29vZ2xlLm1hcHMuTWFya2VyKCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gbmVzdEljb24obmVzdCkge1xuICBjb25zdCBuZXN0UG9rZW1vbiA9IG5lc3RNaWdyYXRpb25EYXRhKG5lc3QsIG1pZ3JhdGlvbkRhdGVzWzBdKTtcblxuICBpZiAobmVzdFBva2Vtb24pIHtcbiAgICByZXR1cm4ge1xuICAgICAgdXJsOiBgJHtwb2tlbW9uSW1hZ2VzVXJsfS8ke25lc3RQb2tlbW9uLmlkfS5wbmdgLFxuICAgICAgc2NhbGVkU2l6ZTogbmV3IGdvb2dsZS5tYXBzLlNpemUoMzQsIDM0KSxcbiAgICAgIGFuY2hvcjogbmV3IGdvb2dsZS5tYXBzLlBvaW50KDE3LCAxNylcbiAgICB9O1xuICB9XG59XG5cbmZ1bmN0aW9uIG5lc3RMYWJlbChuZXN0KSB7XG4gIGZ1bmN0aW9uIHBva2Vtb25OYW1lU3RyKHBva2Vtb24pIHtcbiAgICByZXR1cm4gcG9rZW1vbiA/IGAke3Bva2Vtb24ubmFtZX0gKCMke3Bva2Vtb24uaWR9KWAgOiAnPyc7XG4gIH1cblxuICBjb25zdCBhbGxOZXN0aW5nUG9rZW1vbiA9ICQubWFwKG1pZ3JhdGlvbkRhdGVzLCBmdW5jdGlvbiAoZGF0ZSwgaW5kZXgpIHtcbiAgICBjb25zdCBkYXRlU3RyID0gKGluZGV4ID09IDApID8gJ0N1cnJlbnQnIDogZGF0ZVRvU3RyaW5nKGRhdGUpO1xuICAgIGNvbnN0IHBva2Vtb24gPSBuZXN0TWlncmF0aW9uRGF0YShuZXN0LCBkYXRlKTtcblxuICAgIHJldHVybiBgXG4gICAgICA8ZGl2IGNsYXNzPVwibmVzdC1sYWJlbC1wb2tlbW9uXCI+XG4gICAgICAgICR7ZGF0ZVN0cn06ICR7cG9rZW1vbk5hbWVTdHIocG9rZW1vbil9XG4gICAgICA8L2Rpdj5gO1xuICB9KS5qb2luKCdcXG4nKTtcblxuICBjb25zdCBiYXNlVVJMID0gbG9jYXRpb24ucHJvdG9jb2wgKyAnLy8nICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lO1xuICBjb25zdCBwZXJtYUxpbmsgPSBgJHtiYXNlVVJMfT9uZXN0PSR7bmVzdC5wZXJtYWxpbmtOYW1lfWA7XG5cbiAgbGV0IHNwYXducG9pbnRDb3VudFxuICBpZiAobmVzdC5zcGF3bnBvaW50cykge1xuICAgIGlmIChuZXN0LnNwYXducG9pbnRzID4gMSkge1xuICAgICAgc3Bhd25wb2ludENvdW50ID0gYCR7bmVzdC5zcGF3bnBvaW50c30gc3Bhd25wb2ludHNgO1xuICAgIH0gZWxzZSB7XG4gICAgICBzcGF3bnBvaW50Q291bnQgPSBgJHtuZXN0LnNwYXducG9pbnRzfSBzcGF3bnBvaW50YDtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgc3Bhd25wb2ludENvdW50ID0gJ051bWJlciBvZiBzcGF3bnBvaW50cyB1bmtub3duJztcbiAgfVxuXG4gIGxldCBjb250ZW50ID0gYFxuICAgIDxkaXYgY2xhc3M9XCJuZXN0LWxhYmVsXCI+XG4gICAgICA8ZGl2IGNsYXNzPVwibmVzdC1sYWJlbC1uYW1lXCI+XG4gICAgICAgIDxiPiR7bmVzdC5uYW1lfTwvYj5cbiAgICAgICAgPGEgaHJlZj1cIiR7cGVybWFMaW5rfVwiPjxzcGFuIGNsYXNzPVwiZmFzIGZhLWxpbmtcIj48L3NwYW4+PC9hPlxuICAgICAgPC9kaXY+XG4gICAgICA8ZGl2IGNsYXNzPVwibmVzdC1sYWJlbC1zcGF3bnBvaW50c1wiPlxuICAgICAgICAoJHtzcGF3bnBvaW50Q291bnR9KVxuICAgICAgPC9kaXY+XG4gICAgICA8YnIvPlxuICAgICAgJHthbGxOZXN0aW5nUG9rZW1vbn1cbiAgICA8L2Rpdj5gO1xuXG4gIHJldHVybiBuZXcgZ29vZ2xlLm1hcHMuSW5mb1dpbmRvdyh7XG4gICAgY29udGVudDogY29udGVudFxuICB9KTtcbn1cblxuZnVuY3Rpb24gbmVzdE1pZ3JhdGlvbkRhdGEobmVzdCwgbWlncmF0aW9uKSB7XG4gIGlmIChuZXN0Lm1pZ3JhdGlvbnMgJiZcbiAgICAgIG5lc3QubWlncmF0aW9uc1ttaWdyYXRpb25dICYmXG4gICAgICAobmVzdC5taWdyYXRpb25zW21pZ3JhdGlvbl1bJ2lkJ10gPiAwKSkge1xuICAgIHJldHVybiBuZXN0Lm1pZ3JhdGlvbnNbbWlncmF0aW9uXTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjb29yZGluYXRlVG9MYXRMbmcob29vcmQpIHtcbiAgcmV0dXJuIG5ldyBnb29nbGUubWFwcy5MYXRMbmcob29vcmRbMF0sIG9vb3JkWzFdKTtcbn1cblxuZnVuY3Rpb24gZGF0ZVRvU3RyaW5nKGRhdGUpIHtcbiAgICBmdW5jdGlvbiBwYWQobikge1xuICAgICAgcmV0dXJuIChuIDwgMTApID8gJzAnICsgbiA6IG47XG4gICAgfVxuXG4gICAgcmV0dXJuIHBhZChkYXRlLmdldEZ1bGxZZWFyKCkpICsgJy0nICtcbiAgICAgICAgICAgcGFkKGRhdGUuZ2V0TW9udGgoKSkgKyAnLScgK1xuICAgICAgICAgICBwYWQoZGF0ZS5nZXREYXRlKCkpO1xufVxuIl19
